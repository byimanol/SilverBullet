name: Build SilverBullet

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019  # Equivalente a Visual Studio 2017
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive  # Equivalente a git submodule update --init --recursive
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Get commit count (REV)
      id: rev
      run: |
        $rev = git rev-list --count HEAD
        echo "REV=$rev" >> $env:GITHUB_ENV
        echo "Commit count: $rev"
      shell: pwsh
      
    - name: Restore NuGet packages
      run: nuget restore OpenBullet.sln
      
    - name: Build solution
      run: msbuild OpenBullet.sln /p:Configuration=Release /p:Platform="Any CPU" /verbosity:normal
      
    - name: Move driver files to bin folder
      run: |
        # Crear directorio bin si no existe
        New-Item -ItemType Directory -Force -Path "openbullet\bin\release\bin"
        
        # Mover chromedriver.exe si existe
        if (Test-Path "openbullet\bin\release\chromedriver.exe") {
          Move-Item -Force "openbullet\bin\release\chromedriver.exe" "openbullet\bin\release\bin\"
          Write-Host "Moved chromedriver.exe"
        } else {
          Write-Host "chromedriver.exe not found"
        }
        
        # Mover geckodriver.exe si existe
        if (Test-Path "openbullet\bin\release\geckodriver.exe") {
          Move-Item -Force "openbullet\bin\release\geckodriver.exe" "openbullet\bin\release\bin\"
          Write-Host "Moved geckodriver.exe"
        } else {
          Write-Host "geckodriver.exe not found"
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Create ZIP archive
      run: |
        # Comprimir la carpeta release
        Compress-Archive -Path "openbullet\bin\release\*" -DestinationPath "OpenBullet.zip" -Force
        Write-Host "Created OpenBullet.zip"
      shell: pwsh
      
    - name: Upload OpenBullet ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenBullet
        path: OpenBullet.zip
        
    - name: Upload Release folder artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenBullet-Release-Folder
        path: openbullet/bin/release/
        
    - name: Create Release
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: 1.2.2#${{ env.REV }}
        name: Release 1.2.2#${{ env.REV }}
        files: OpenBullet.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
