name: Build SilverBullet

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Get commit count (REV)
      id: rev
      run: |
        $rev = git rev-list --count HEAD
        echo "REV=$rev" >> $env:GITHUB_ENV
        echo "Commit count: $rev"
      shell: pwsh
      
    - name: Fix duplicate Solution Items in .sln file
      run: |
        Write-Host "Fixing OpenBullet.sln..."
        $slnContent = Get-Content "OpenBullet.sln" -Raw
        
        # Buscar todas las secciones "Solution Items"
        $pattern = 'Project\("{2150E333-8FDC-42A3-9474-1A3956D46DE8}"\) = "Solution Items"'
        $matches = [regex]::Matches($slnContent, $pattern)
        
        if ($matches.Count -gt 1) {
          Write-Host "Found $($matches.Count) 'Solution Items' sections. Removing duplicates..."
          
          # Leer línea por línea y eliminar secciones duplicadas
          $lines = Get-Content "OpenBullet.sln"
          $newLines = @()
          $skipUntilEndProject = $false
          $solutionItemsCount = 0
          
          for ($i = 0; $i -lt $lines.Count; $i++) {
            $line = $lines[$i]
            
            # Detectar inicio de Solution Items
            if ($line -match 'Project\("{2150E333-8FDC-42A3-9474-1A3956D46DE8}"\) = "Solution Items"') {
              $solutionItemsCount++
              
              # Mantener solo el primero, saltar los demás
              if ($solutionItemsCount -gt 1) {
                Write-Host "Removing duplicate Solution Items section #$solutionItemsCount"
                $skipUntilEndProject = $true
                continue
              }
            }
            
            # Si estamos saltando, buscar EndProject
            if ($skipUntilEndProject) {
              if ($line -match "^EndProject") {
                $skipUntilEndProject = $false
              }
              continue
            }
            
            $newLines += $line
          }
          
          # Guardar archivo modificado
          $newLines | Set-Content "OpenBullet.sln" -Encoding UTF8
          Write-Host "Fixed OpenBullet.sln - removed duplicate Solution Items"
        } else {
          Write-Host "No duplicate Solution Items found"
        }
      shell: pwsh
      
    - name: Restore NuGet packages
      run: nuget restore OpenBullet.sln
      
    - name: Build solution
      run: msbuild OpenBullet.sln /p:Configuration=Release /p:Platform="Any CPU" /verbosity:normal
      
    - name: Move driver files to bin folder
      run: |
        New-Item -ItemType Directory -Force -Path "openbullet\bin\release\bin"
        
        if (Test-Path "openbullet\bin\release\chromedriver.exe") {
          Move-Item -Force "openbullet\bin\release\chromedriver.exe" "openbullet\bin\release\bin\"
          Write-Host "Moved chromedriver.exe"
        }
        
        if (Test-Path "openbullet\bin\release\geckodriver.exe") {
          Move-Item -Force "openbullet\bin\release\geckodriver.exe" "openbullet\bin\release\bin\"
          Write-Host "Moved geckodriver.exe"
        }
      shell: pwsh
      continue-on-error: true
      
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "openbullet\bin\release\*" -DestinationPath "OpenBullet.zip" -Force
        Write-Host "Created OpenBullet.zip"
      shell: pwsh
      
    - name: Upload OpenBullet ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenBullet
        path: OpenBullet.zip
        
    - name: Upload Release folder artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenBullet-Release-Folder
        path: openbullet/bin/release/
        
    - name: Create Release
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: 1.2.2#${{ env.REV }}
        name: Release 1.2.2#${{ env.REV }}
        files: OpenBullet.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
